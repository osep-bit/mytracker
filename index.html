<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expense Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Configure Tailwind to use the Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }
        /* Custom CSS for the loading spinner animation */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin 1s linear infinite;
        }
        /* Styles for Tab Navigation */
        .tab-button {
            padding: 0.75rem 1rem;
            color: #d1d5db; /* Gray-300 */
            font-weight: 500;
            transition: all 0.15s ease-in-out;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        @media (min-width: 640px) {
            .tab-button {
                padding: 1rem 1.5rem;
            }
        }
        .tab-button:hover {
            color: #f3f4f6; /* Gray-50 */
        }
        .tab-button.active {
            color: #818cf8; /* Indigo-400 */
            border-bottom-color: #818cf8;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-2 sm:p-8">

    <!-- Login Screen -->
    <div id="login-screen" class="w-full max-w-sm mx-auto">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700">
            <div class="text-center mb-6">
                 <h1 class="text-3xl font-bold text-white">Expense Tracker</h1>
                 <p class="text-gray-400 mt-2">Please enter the password to continue</p>
            </div>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm mb-4" placeholder="Password">
            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150">
                Unlock
            </button>
            <p id="login-error" class="text-red-400 text-center text-sm mt-4 hidden">Incorrect password. Please try again.</p>
        </div>
    </div>


    <!-- App Container (Initially Hidden) -->
    <div id="app" class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-xl overflow-hidden border border-gray-700 hidden">
        
        <!-- Status Banner -->
        <div id="status-banner" class="p-3 text-center text-sm font-medium transition-all duration-300">
            <!-- Content updated by JavaScript -->
        </div>

        <!-- Tab Navigation -->
        <nav class="flex border-b border-gray-700">
            <button onclick="switchTab('entry')" class="tab-button active" data-tab="entry">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span class="hidden sm:inline ml-2">New Entry</span>
            </button>
            <button onclick="switchTab('history')" class="tab-button" data-tab="history">
                <i data-lucide="history" class="w-5 h-5"></i>
                <span class="hidden sm:inline ml-2">History</span>
            </button>
            <button onclick="switchTab('analytics')" class="tab-button" data-tab="analytics">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                <span class="hidden sm:inline ml-2">Analytics</span>
            </button>
            
            <div class="ml-auto flex items-center">
                <button id="sync-button" onclick="handleSyncClick()" title="Manual Data Sync" class="tab-button">
                    <i data-lucide="rotate-cw" id="sync-icon" class="w-5 h-5"></i>
                </button>
                <button onclick="switchTab('settings')" class="tab-button" data-tab="settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div id="content-container" class="p-4 sm:p-6">
            
            <!-- Entry Tab -->
            <div id="entry" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-100 mb-4">Paste your new entry</h2>
                <textarea id="sms-input" rows="6" class="w-full p-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 shadow-sm" placeholder="Paste bank SMS messages here (can be multiple entries at once)."></textarea>
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <button onclick="previewTransaction()" class="w-full sm:w-1/2 bg-indigo-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150">
                        Submit
                    </button>
                    <button id="submit-button" onclick="submitTransaction()" class="w-full sm:w-1/2 bg-green-500 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-green-600 transition duration-150 opacity-50 cursor-not-allowed" disabled>
                        Confirm
                    </button>
                </div>
                <div id="parsed-preview" class="hidden border border-gray-600 rounded-lg p-4 bg-gray-700">
                    <h3 class="text-lg font-semibold text-gray-200 mb-3 flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2"></i> Auto-Parsed Transaction Preview
                    </h3>
                    <div id="preview-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-100 mb-4">Transaction History</h2>
                <div id="history-list" class="space-y-3 max-h-[70vh] custom-scrollbar overflow-y-auto">
                    <p class="text-gray-400 text-center py-8">Loading history...</p>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-100 mb-6">Financial Analytics & Summary</h2>
                <div id="analytics-content" class="space-y-6">
                    <div id="total-balance-card" class="mb-6 p-4 bg-indigo-900/50 rounded-lg shadow-xl border border-indigo-700">
                        <p class="text-lg font-medium text-indigo-300 flex items-center">
                            <i data-lucide="banknote" class="w-5 h-5 mr-2"></i> Current Account Balance (Latest)
                        </p>
                        <p id="current-balance-display" class="text-4xl font-extrabold text-indigo-100 mt-2">--.--</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-900/50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium text-blue-300 flex items-center"><i data-lucide="arrow-up-circle" class="w-4 h-4 mr-2"></i>Total Income</p>
                            <p id="total-income" class="text-2xl font-bold text-blue-100 mt-1">0.00</p>
                        </div>
                        <div class="p-4 bg-red-900/50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium text-red-300 flex items-center"><i data-lucide="arrow-down-circle" class="w-4 h-4 mr-2"></i>Total Expense</p>
                            <p id="total-expense" class="text-2xl font-bold text-red-100 mt-1">0.00</p>
                        </div>
                        <div class="p-4 bg-green-900/50 rounded-lg shadow-sm">
                            <p class="text-sm font-medium text-green-300 flex items-center"><i data-lucide="scale" class="w-4 h-4 mr-2"></i>Net Flow</p>
                            <p id="net-flow" class="text-2xl font-bold text-green-100 mt-1">0.00</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-200 mb-3">Expense Breakdown by Category</h3>
                        <div id="category-breakdown" class="space-y-2">
                            <p class="text-gray-400">No data available.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-100 mb-4 flex items-center">
                    <i data-lucide="settings" class="w-6 h-6 mr-2"></i> Google Sheet Integration
                </h2>
                <div class="space-y-6">
                    <div>
                        <p class="text-gray-300 mb-3">
                            To connect your Google Sheet, deploy the Apps Script as a Web App and paste the unique URL below. This is the only step required to sync your data.
                        </p>
                        <div class="p-4 bg-indigo-900/50 rounded-lg border border-indigo-700">
                            <label for="sheets-api-url-input" class="block text-sm font-medium text-indigo-300 mb-2">
                                Google Apps Script Web App URL
                            </label>
                            <input type="url" id="sheets-api-url-input" class="w-full p-3 border border-indigo-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="Paste your script URL here (starts with https://script.google.com/macros/s/...)">
                            <button onclick="saveApiUrl()" class="mt-3 bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150">
                                Save URL
                            </button>
                            <p id="api-url-save-status" class="mt-2 text-sm text-green-700 font-medium hidden">URL saved successfully!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        let currentTab = 'entry';
        let tempTransactions = []; 
        let allTransactions = []; 
        const LOCAL_STORAGE_API_URL_KEY = 'expenseTrackerApiUrl';
        let sheetApiUrl = '';
        const CATEGORIES = ['Bills', 'Groceries', 'Dining Out', 'Shopping', 'Travel', 'Utilities', 'Salary', 'Rent', 'Investment', 'Transfer', 'Miscellaneous', 'Uncategorized'];
        const BANKS = ['Select Bank', 'Liv', 'Masreq', 'RAK', 'Emirates Islamic', 'ADCB'];
        const APP_PASSWORD = '6112';

        // --- LOGIN LOGIC ---

        /**
         * Handles the login attempt by comparing the input to the stored password.
         */
        function handleLogin() {
            const passwordInput = document.getElementById('password-input');
            const loginError = document.getElementById('login-error');
            
            const enteredPassword = passwordInput.value;

            if (enteredPassword === APP_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                // Initialize the app only after successful login
                loadSettings();
            } else {
                loginError.classList.remove('hidden');
            }
        }
        
        // Add event listener for Enter key on password input
        document.getElementById('password-input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });


        // --- UI UTILITIES ---

        /**
         * Updates the main status banner based on whether the API URL is configured.
         * @param {string} url The configured Google Apps Script URL.
         */
        function updateStatusBanner(url) {
            const banner = document.getElementById('status-banner');
            if (url && url.startsWith('http')) {
                banner.className = 'p-3 text-center text-sm font-medium bg-green-900 text-green-300 rounded-t-lg transition-all duration-300';
                banner.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i> Integration Active. Data will be saved to your Google Sheet.';
            } else {
                banner.className = 'p-3 text-center text-sm font-medium bg-red-900 text-red-300 rounded-t-lg transition-all duration-300';
                banner.innerHTML = '<i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> <strong>Warning:</strong> Google Sheet URL is missing. Go to <strong>Settings</strong> to configure.';
            }
            lucide.createIcons();
        }
        
        /**
         * Shows a temporary message in the status banner.
         * @param {string} message The message to display.
         * @param {boolean} isError If true, displays the message with an error style.
         */
        function showTemporaryBanner(message, isError = false) {
            const banner = document.getElementById('status-banner');
            if (isError) {
                banner.className = 'p-3 text-center text-sm font-medium bg-red-900 text-red-300 rounded-t-lg transition-all duration-300';
                banner.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4 inline mr-1"></i> ${message}`;
            } else {
                banner.className = 'p-3 text-center text-sm font-medium bg-blue-900 text-blue-300 rounded-t-lg transition-all duration-300';
                banner.innerHTML = `<i data-lucide="info" class="w-4 h-4 inline mr-1"></i> ${message}`;
            }
            lucide.createIcons();
            setTimeout(() => { updateStatusBanner(sheetApiUrl); }, 4000);
        }

        /**
         * Toggles the loading state of the main sync button.
         * @param {boolean} isLoading True to show the loading spinner.
         */
        function toggleSyncLoading(isLoading) {
            const button = document.getElementById('sync-button');
            const icon = document.getElementById('sync-icon');
            if (!button || !icon) return;

            button.disabled = isLoading;
            button.classList.toggle('animate-spin-slow', isLoading);
            icon.setAttribute('data-lucide', isLoading ? 'loader-2' : 'rotate-cw');
            lucide.createIcons();
        }

        // --- SETTINGS & INITIALIZATION ---
        
        /**
         * Loads saved settings from localStorage and performs an initial data sync.
         */
        function loadSettings() {
            lucide.createIcons(); // Make sure icons in the main app are rendered
            const storedApiUrl = localStorage.getItem(LOCAL_STORAGE_API_URL_KEY);
            const apiUrlInput = document.getElementById('sheets-api-url-input');
            if (storedApiUrl) {
                sheetApiUrl = storedApiUrl;
                if (apiUrlInput) apiUrlInput.value = storedApiUrl;
            }
            updateStatusBanner(sheetApiUrl);
            handleSyncClick();
        }

        /**
         * Saves the Google Apps Script URL from the settings input to localStorage.
         */
        function saveApiUrl() {
            const input = document.getElementById('sheets-api-url-input');
            const status = document.getElementById('api-url-save-status');
            const url = input.value.trim();

            if (url && url.startsWith('http')) {
                localStorage.setItem(LOCAL_STORAGE_API_URL_KEY, url);
                sheetApiUrl = url;
                updateStatusBanner(sheetApiUrl);
                status.textContent = 'URL saved successfully!';
                status.classList.remove('hidden', 'text-red-300');
                status.classList.add('text-green-300');
                handleSyncClick();
            } else {
                status.textContent = 'Invalid URL format.';
                status.classList.remove('hidden', 'text-green-300');
                status.classList.add('text-red-300');
            }
        }
        
        // --- TAB NAVIGATION ---

        /**
         * Handles the logic for switching between application tabs.
         * @param {string} tabId The ID of the tab to switch to ('entry', 'history', etc.).
         */
        function switchTab(tabId) {
            // Update UI for active tab
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            currentTab = tabId;

            // Perform actions based on the new tab
            if (tabId === 'history' || tabId === 'analytics') {
                handleSyncClick();
            } else if (tabId === 'entry') {
                tempTransactions = [];
                document.getElementById('sms-input').value = '';
                renderPreviewList();
            }
        }

        // --- SMS PARSING & TRANSACTION LOGIC ---

        /**
         * Parses a raw SMS string into a structured transaction object.
         * @param {string} smsText The raw bank SMS message.
         * @returns {object|null} A transaction object or null if parsing fails.
         */
        function parseSms(smsText) {
            const fullSms = smsText.replace(/\n/g, ' ').trim();
            if (!fullSms) return null;

            // Default transaction structure
            const transaction = {
                Timestamp: new Date().toISOString(),
                Date: new Date().toISOString().substring(0, 10), 
                Type: 'Expense', 
                Amount: 0.00, 
                Description: 'Unknown Transaction', 
                Category: 'Uncategorized', 
                Bank: 'Select Bank',
                Balance: 0.00,
                RawSms: smsText
            };

            // Regex patterns for data extraction
            const amountPattern = /(?:AED|Rs|INR|USD)\s*([\d,]+\.?\d*)/i;
            const balancePattern = /(?:Avl Bal|Balance|available balance)\s*is?\s*(?:AED|Rs|INR|USD)?\s*([\d,]+\.?\d*)/i;
            const datePattern = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})/i;

            // 1. Extract Amount (critical)
            const amountMatch = fullSms.match(amountPattern);
            if (amountMatch && parseFloat(amountMatch[1].replace(/,/g, '')) > 0) {
                transaction.Amount = parseFloat(amountMatch[1].replace(/,/g, ''));
            } else {
                return null; // A transaction without a valid amount is not processed.
            }

            // 2. Extract Balance
            const balanceMatch = fullSms.match(balancePattern);
            if (balanceMatch) transaction.Balance = parseFloat(balanceMatch[1].replace(/,/g, '')) || 0;
            
            // 3. Extract Date
            const dateMatch = fullSms.match(datePattern);
            if (dateMatch) {
                const parsedDate = new Date(dateMatch[0].replace(/-/g, '/'));
                if (!isNaN(parsedDate)) transaction.Date = parsedDate.toISOString().substring(0, 10);
            }

            // 4. Determine Type
            if (/(credited|deposit|received)/i.test(fullSms)) {
                transaction.Type = 'Income';
            } else if (/(debited|purchase|paid|sent|spent)/i.test(fullSms)) {
                transaction.Type = 'Expense';
            }

            // 5. Determine Description
            let description = 'Unspecified Transaction';
            const towardsMatch = fullSms.match(/(?:towards|at|to|for)\s+([^.]+)/i);
            if (towardsMatch && towardsMatch[1]) {
                description = towardsMatch[1].replace(/your account \w+/, '').trim();
            }
            transaction.Description = description;

            return transaction;
        }

        /**
         * Analyzes the text in the input box and updates the preview list.
         */
        function previewTransaction() {
            const input = document.getElementById('sms-input').value.trim();
            const smsBlocks = input.split(/\n\s*\n/).map(block => block.trim()).filter(Boolean);
            tempTransactions = smsBlocks.map(parseSms).filter(Boolean);
            renderPreviewList();
        }

        /**
         * Updates the category of a transaction in the temporary list.
         * @param {Event} event The onchange event from the select dropdown.
         */
        function updateCategory(event) {
            const index = event.target.dataset.index;
            const newCategory = event.target.value;
            if (tempTransactions[index]) {
                tempTransactions[index].Category = newCategory;
            }
        }

        /**
         * Updates the bank of a transaction in the temporary list.
         * @param {Event} event The onchange event from the select dropdown.
         */
        function updateBank(event) {
            const index = event.target.dataset.index;
            const newBank = event.target.value;
            if (tempTransactions[index]) {
                tempTransactions[index].Bank = newBank;
            }
        }
        
        // --- DATA PERSISTENCE ---
        
        /**
         * Wrapper for fetch with exponential backoff for retries.
         * @param {string} url The URL to fetch.
         * @param {object} options Fetch options.
         * @param {number} maxRetries Maximum number of retries.
         * @returns {Promise<Response>} The fetch response.
         */
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (options.mode === 'no-cors') return response;
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }
        
        /**
         * Sends an array of transactions to the configured Google Sheet.
         * @param {Array<Array>} dataAsArrays Transactions formatted as an array of arrays.
         * @returns {Promise<boolean>} True on success, false on failure.
         */
        async function sendToGoogleSheet(dataAsArrays) {
            if (!sheetApiUrl) return false;
            try {
                await fetchWithRetry(sheetApiUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transactions: dataAsArrays })
                });
                return true;
            } catch (error) {
                console.error('Failed to send transaction:', error);
                return false; 
            }
        }

        /**
         * Fetches the entire transaction history from the Google Sheet.
         */
        async function fetchHistoryFromSheet() {
            if (!sheetApiUrl) {
                renderHistoryList([]);
                renderAnalytics([]);
                return;
            }
            document.getElementById('history-list').innerHTML = '<p class="text-gray-400 text-center py-8">Loading history...</p>';
            try {
                const cacheBustUrl = sheetApiUrl + (sheetApiUrl.includes('?') ? '&' : '?') + 'cacheBust=' + new Date().getTime();
                const response = await fetchWithRetry(cacheBustUrl);
                const data = await response.json();
                allTransactions = data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            } catch (error) {
                console.error('Failed to fetch history:', error);
                allTransactions = [];
            }
            renderHistoryList(allTransactions);
            renderAnalytics(allTransactions);
        }
        /**
         * Main sync handler, called by buttons and tab switches.
         */
        async function handleSyncClick() {
            toggleSyncLoading(true);
            await fetchHistoryFromSheet();
            toggleSyncLoading(false);
        }

        /**
         * Submits the prepared transactions, updates the UI, and syncs data.
         */
        async function submitTransaction() {
            if (tempTransactions.length === 0) return;

            const incompleteTransaction = tempTransactions.find(t => t.Category === 'Uncategorized' || t.Bank === 'Select Bank');
            if (incompleteTransaction) {
                showTemporaryBanner('Please select a category and bank for all entries.', true);
                return; 
            }

            const validTransactions = tempTransactions.filter(t => t && t.Amount > 0);
            if (validTransactions.length === 0) {
                showTemporaryBanner("No valid transactions to submit.", true);
                return;
            }

            const transactionsAsArrays = validTransactions.map(t => [
                t.Timestamp, t.Date, t.Type, t.Amount,
                t.Description, t.Category, t.Bank, t.Balance, t.RawSms
            ]);

            const success = await sendToGoogleSheet(transactionsAsArrays);

            if(success) {
                showTemporaryBanner('Transaction(s) saved!', false);
                allTransactions.unshift(...validTransactions);
                allTransactions.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

                tempTransactions = [];
                document.getElementById('sms-input').value = '';
                renderPreviewList();
                switchTab('history');
                setTimeout(() => handleSyncClick(), 1500);
            } else {
                 showTemporaryBanner('Failed to save transaction.', true);
            }
        }

        // --- UI RENDERING ---

        /**
         * Renders the list of transactions in the preview area.
         */
        function renderPreviewList() {
            const previewList = document.getElementById('preview-list');
            const previewContainer = document.getElementById('parsed-preview');
            const submitButton = document.getElementById('submit-button');
        
            const noTransactions = tempTransactions.length === 0;
            previewList.innerHTML = '';
            previewContainer.classList.toggle('hidden', noTransactions);
            submitButton.disabled = noTransactions;
            submitButton.classList.toggle('opacity-50', noTransactions);
            submitButton.classList.toggle('cursor-not-allowed', noTransactions);
            
            if (noTransactions) return;
            
            tempTransactions.forEach((parsed, index) => {
                const isExpense = parsed.Type === 'Expense';
                const icon = isExpense ? 'arrow-down-right' : 'arrow-up-right';
                const color = isExpense ? 'text-red-400' : 'text-green-400'; 
                const bgColor = isExpense ? 'bg-red-900/50' : 'bg-green-900/50';
                
                let categoryOptions = '';
                CATEGORIES.forEach(cat => {
                    const selected = parsed.Category === cat ? 'selected' : '';
                    categoryOptions += `<option value="${cat}" ${selected}>${cat}</option>`;
                });

                let bankOptions = '';
                BANKS.forEach(bank => {
                    const selected = parsed.Bank === bank ? 'selected' : '';
                    bankOptions += `<option value="${bank}" ${selected}>${bank}</option>`;
                });

                previewList.innerHTML += `
                    <div class="flex items-start justify-between p-3 ${bgColor} rounded-md shadow-sm">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-50 truncate">${parsed.Description || 'N/A'}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                <span class="font-mono">${parsed.Date}</span>
                            </div>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <div class="relative">
                                    <i data-lucide="tag" class="w-4 h-4 absolute top-1/2 left-2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                    <select data-index="${index}" onchange="updateCategory(event)" class="bg-gray-600 border border-gray-500 text-white text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5 pl-8">
                                        ${categoryOptions}
                                    </select>
                                </div>
                                <div class="relative">
                                    <i data-lucide="landmark" class="w-4 h-4 absolute top-1/2 left-2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                    <select data-index="${index}" onchange="updateBank(event)" class="bg-gray-600 border border-gray-500 text-white text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5 pl-8">
                                        ${bankOptions}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-base font-bold flex items-center ${color}">
                                <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i> 
                                ${parsed.Amount.toFixed(2)}
                            </div>
                            <div class="text-xs font-semibold ${color} mt-1">
                                ${parsed.Type.toUpperCase()}
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }
        
        /**
         * Renders the full list of transactions in the History tab.
         * @param {Array<object>} transactions The list of transaction objects.
         */
        function renderHistoryList(transactions) {
            const listEl = document.getElementById('history-list');
            const validTransactions = transactions.filter(t => {
                const amount = parseFloat(t.Amount);
                return !isNaN(amount) && amount > 0;
            });

            if (validTransactions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center py-8">No valid transaction history found.</p>';
                return;
            }

            listEl.innerHTML = ''; // Clear existing list
            validTransactions.forEach(t => {
                const isExpense = (t.Type || 'Expense') === 'Expense';
                const icon = isExpense ? 'arrow-down-right' : 'arrow-up-right';
                const color = isExpense ? 'text-red-400' : 'text-green-400';
                const bgColor = isExpense ? 'bg-red-900/50' : 'bg-green-900/50';
                const dateValue = t.Timestamp || t.Date;
                const dateString = dateValue ? new Date(dateValue).toLocaleDateString() : 'Invalid Date';
                let description = t.Description || 'No Description';
                if (description === 'Uncategorized' || description === 'N/A' || description === 'Unspecified Transaction') {
                    description = 'Unspecified Transaction';
                }

                listEl.innerHTML += `
                    <div class="flex items-start justify-between p-3 ${bgColor} rounded-md">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-50 truncate">${description}</div>
                             <div class="text-xs text-gray-400 mt-1">
                                <span class="font-mono">${dateString}</span> | 
                                <span class="font-semibold">Category: ${t.Category || 'Uncategorized'}</span> |
                                <span class="font-semibold flex items-center"><i data-lucide="landmark" class="w-3 h-3 inline-block mr-1"></i>Bank: ${t.Bank || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-base font-bold flex items-center ${color}">
                                <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>${(parseFloat(t.Amount) || 0).toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        /**
         * Calculates and renders the data for the Analytics tab.
         * @param {Array<object>} transactions The list of transaction objects.
         */
        function renderAnalytics(transactions) {
            let totalIncome = 0, totalExpense = 0, latestBalance = 0;
            const categoryTotals = {};
            const validTransactions = transactions.filter(t => {
                const amount = parseFloat(t.Amount);
                return !isNaN(amount) && amount > 0;
            });

            if (validTransactions.length > 0) {
                 latestBalance = parseFloat(validTransactions[0].Balance) || 0;
                 validTransactions.forEach(t => {
                    const amount = parseFloat(t.Amount) || 0;
                    if (t.Type === 'Income') totalIncome += amount;
                    else if (t.Type === 'Expense') {
                        totalExpense += amount;
                        const category = t.Category || 'Uncategorized';
                        categoryTotals[category] = (categoryTotals[category] || 0) + amount;
                    }
                });
            }

            document.getElementById('total-income').textContent = totalIncome.toFixed(2);
            document.getElementById('total-expense').textContent = totalExpense.toFixed(2);
            document.getElementById('net-flow').textContent = (totalIncome - totalExpense).toFixed(2);
            document.getElementById('current-balance-display').textContent = latestBalance.toFixed(2);
            
            const breakdownEl = document.getElementById('category-breakdown');
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            
            if (sortedCategories.length === 0) {
                breakdownEl.innerHTML = '<p class="text-gray-400">No expense data to analyze.</p>';
                return;
            }

            breakdownEl.innerHTML = ''; // Clear existing
            sortedCategories.forEach(([category, amount]) => {
                const percentage = totalExpense > 0 ? ((amount / totalExpense) * 100).toFixed(1) : 0;
                breakdownEl.innerHTML += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-indigo-200">${category}</span>
                            <span class="text-sm font-medium text-gray-300">${amount.toFixed(2)} (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        // --- APP INITIALIZATION ---
        // The app is initialized after a successful login via handleLogin()

    </script>
</body>
</html>

